# Лабораторна робота №3: Діаграма послідовності (Sequence Diagram)

## 1. Загальна інформація
* **Тема:** Моделювання динамічної взаємодії об'єктів у сценарії "Оформлення замовлення".
* **Цільовий Use Case:** `UC6` — Place Order.
* **Покриття вимог (Functional Requirements):**
  * `FR6` (Система повинна дозволяти оформлення замовлення).
  * `FR3` (Перевірка наявності товару).
  * `FR13` (Автоматичне списання товару зі складу).
  * `FR5` (Використання даних кошика).

## 2. Опис сценарію
Діаграма демонструє процес обробки замовлення в умовах розподіленої (мікросервісної) архітектури. Головна складність сценарію полягає у забезпеченні узгодженості даних між трьома незалежними компонентами: Службою замовлень, Складом та Зовнішнім банком.

### Логіка взаємодії (Workflow)
Процес побудований за принципом **Saga (Orchestration based)** або спрощеного **Two-Phase Commit**:

1. **Ініціалізація:** Користувач підтверджує намір купити товари через `Web Store`.
2. **Резервування (Soft Reserve):**
   * `Order Service` циклічно звертається до `Inventory Service`.
   * Товари не списуються відразу, а лише "блокуються" (резервуються) на час проведення оплати.
   * *Альтернативний потік:* Якщо товару немає — процес переривається миттєво.
3. **Оплата (External Call):**
   * Запит передається на зовнішній шлюз `Payment Gateway`.
   * Система очікує синхронної відповіді про успіх або відмову.
4. **Фіксація транзакції (Commit):**
   * Якщо оплата успішна: Замовлення зберігається в БД як `PAID`, склад отримує команду на остаточне списання (`commitStock`), а користувач — email.
5. **Компенсація (Rollback):**
   * Якщо оплата не пройшла: Система виконує **компенсуючу транзакцію** — відправляє запит `releaseReservation`, щоб розблокувати товари для інших покупців.

## 3. Учасники взаємодії (Participants)

| Учасник | Тип | Опис ролі |
| :--- | :--- | :--- |
| **User** | Actor | Кінцевий користувач, ініціатор запиту. |
| **Web Store** | Frontend | Вітрина магазину. Відповідає лише за відображення даних та первинний прийом команд. |
| **Order Service** | Backend (Orchestrator) | Головний керуючий сервіс. Він знає бізнес-логіку процесу, але не зберігає дані про залишки товарів. |
| **Inventory Service** | Backend (Microservice) | Сервіс, що відповідає за складський облік. Має монопольний доступ до даних про наявність (`Products table`). |
| **Payment Gateway** | External System | Зовнішня банківська система (наприклад, LiqPay/Stripe). |
| **Notification Service**| Backend (Microservice) | Сервіс для асинхронної відправки повідомлень (Email/SMS), щоб не затримувати відповідь інтерфейсу. |
| **Shared Database** | Database | Сховище даних для персистентності замовлень та товарів. |

## 4. Ключові особливості реалізації
1. **Розподіл відповідальності:** Сервіс замовлень не звертається до бази даних товарів напряму, а використовує API `Inventory Service`.
2. **Атомарність операцій:** Використання механізму резервування гарантує, що товар не буде проданий, якщо його немає, і не буде списаний, якщо оплата не пройшла.
3. **Обробка помилок:** Реалізовано повний шлях обробки відмов (відсутність товару, відхилення платіжної картки).