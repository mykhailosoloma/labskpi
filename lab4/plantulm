@startuml
skinparam monochrome true
skinparam shadowing false

|Покупець|
|Магазин (Web Store)|
|Склад (Inventory)|
|Платіжний шлюз (Bank)|

|Покупець|
start
:Натиснути кнопку\n«Оплатити замовлення»;

|Магазин (Web Store)|
label payment_form
:Відобразити форму\nоплати;

|Покупець|
:Ввести номер картки,\nтермін та CVV;

if (Зберегти картку?) then (Так)
    :Поставити галочку\n"Запам'ятати";
else (Ні)
endif

|Магазин (Web Store)|
:Попередня валідація\nданих картки;

if (Дані коректні?) then (Ні)
    :Показати помилку\nвведення;
    goto payment_form
else (Так)
    :Підготувати запит;
endif

|Покупець|
if (Підтвердити оплату?) then (Скасувати)
    :Скасувати замовлення;
    stop
else (Сплатити)
    :Натиснути "Pay";
endif

|Магазин (Web Store)|
:Запит на наявність;

|Склад (Inventory)|
:Перевірити залишки;

if (Товар є в наявності?) then (Ні)
    |Магазин (Web Store)|
    :Помилка: "Товар закінчився";
    goto payment_form
else (Так)
    |Склад (Inventory)|
    :Тимчасовий резерв;
endif

|Магазин (Web Store)|
fork
    :Показати анімацію\n"Обробка платежу...";
fork again
    :Надіслати транзакцію\nв банк;
    
    |Платіжний шлюз (Bank)|
    :Перевірити ліміти\nта баланс;
    :Списати кошти;
    :Повернути результат;
    
    |Магазин (Web Store)|
    :Отримати відповідь\nвід шлюзу;
end fork

if (Оплата пройшла?) then (Успіх)
    |Магазин (Web Store)|
    :Підтвердити списання;
    
    |Склад (Inventory)|
    :Фінальне списання;

    |Покупець|
    :Показати чек та\nномер замовлення;
    stop
else (Відхилено)
    |Магазин (Web Store)|
    :Скасувати резерв;
    
    |Склад (Inventory)|
    :Розблокувати товар;

    |Покупець|
    :Показати причину\n(Недостатньо коштів);
    goto payment_form
endif

@enduml